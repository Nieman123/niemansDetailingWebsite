name: Build images & deploy to Firebase Hosting

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          registry-url: 'https://registry.npmjs.org'

      - name: Install deps
        run: npm ci

      - name: Cache generated images
        id: cache-images
        uses: actions/cache@v4
        with:
          path: |
            public/images
          key: ${{ runner.os }}-images-${{ hashFiles('tools/build-images.mjs', 'assets/images/**') }}

      - name: Build responsive images (incremental)
        if: steps.cache-images.outputs.cache-hit != 'true'
        run: npm run build:images

      # If you have a site build step, add it here
      - name: Build site
        run: echo "No build step configured"

      - name: Build Static Blog
        run: npm run build:blog

      - name: Rewire HTML to responsive images
        run: npm run img:rewire

      - name: Lighthouse CI (pre-deploy)
        run: npm run lhci
        continue-on-error: true

      - name: Upload Lighthouse report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-report
          path: .lighthouseci
          if-no-files-found: ignore
          include-hidden-files: true

      - name: Setup Firebase auth (main)
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        env:
          FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_NIEMANSDETAILING }}
        run: |
          SA_PATH="$RUNNER_TEMP/firebase-sa.json"
          printf '%s' "$FIREBASE_SERVICE_ACCOUNT" > "$SA_PATH"
          echo "GOOGLE_APPLICATION_CREDENTIALS=$SA_PATH" >> "$GITHUB_ENV"

      - name: Install Firebase CLI (main)
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        run: npm install --global firebase-tools

      - name: Build Functions (main)
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        run: |
          npm --prefix functions ci
          npm --prefix functions run build

      - name: Deploy Functions + Firestore rules/indexes (main)
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        run: |
          firebase deploy \
            --project niemansdetailing \
            --only functions:api,firestore:rules,firestore:indexes \
            --non-interactive

      # Live deploy on pushes to main
      - name: Deploy Live (main)
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_NIEMANSDETAILING }}
          projectId: niemansdetailing
          channelId: live
